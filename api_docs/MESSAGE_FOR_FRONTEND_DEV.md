# Обновление API: Портфель, Активы и Пересчет Целей

Мы добавили на бэкенд логику для построения дашбордов и динамического пересчета плана.

## 1. Получение данных клиента (Дашборды)
**Endpoint**: `GET /api/client/:id`

Теперь в объекте клиента приходит поле `goals_summary` (результат последнего расчета), которое содержит объект `consolidated_portfolio`. Используйте его для построения графиков.

```json
{
  "goals_summary": {
    "summary": {
      "consolidated_portfolio": {
        // ДЛЯ PIE CHART: СТРУКТУРА АКТИВОВ
        "assets_allocation": [
          { "name": "Депозит", "amount": 1000000, "share": 50, "yield": 15 },
          { "name": "Инвестиции", "amount": 1000000, "share": 50, "yield": 20 }
        ],
        // ДЛЯ BAR/PIE CHART: ЕЖЕМЕСЯЧНЫЕ ВЗНОСЫ
        "cash_flow_allocation": [
          { "name": "Инвестиции (Smart)", "amount": 50000, "payment_frequency": "monthly" },
          { "name": "Страхование Жизни", "amount": 42000, "payment_frequency": "annual" } // Обратите внимание на частоту!
        ],
        "total_initial_capital": 2000000,
        "total_monthly_replenishment": 53500 // Приведенное к месяцу (50к + 42к/12)
      },
      // ДЛЯ ГРАФИКА ПДС (Уже было, но напоминаю)
      "pds_cofinancing": { ... }
    },
    "goals": [ ... ] // Детали по каждой цели
  },
  "assets": [ ... ] // Текущие активы клиента (Для отдельного графика "Текущий капитал")
}
```

## 2. Пересчет плана ("Что если?")
**Endpoint**: `POST /api/client/:id/recalculate`

Используйте этот метод, когда клиент хочет поменять параметры цели (срок, сумму) или свои активы/доход прямо внутри плана.

**Request Body (все поля опциональны, отправляйте только то, что изменилось):**
```json
{
  // 1. Изменение параметров целей
  "goals": [
    {
      "goal_type_id": 1,
      "name": "Пенсия",
      "target_amount": 50000000, // Увеличили цель
      "risk_profile": "AGGRESSIVE" // Поменяли риск
      // ...остальные поля цели
    }
    // Отправляйте ВЕСЬ массив целей, даже тех, что не менялись, иначе могут удалиться/сброситься
  ],

  // 2. Изменение данных клиента (Активы, Доход)
  "client": {
    "avg_monthly_income": 300000,
    "total_liquid_capital": 5000000, // Клиент нашел еще денег
    "assets": [ ... ] // Можно обновить список активов
  }
}
```

**Response:**
Возвращает тот же объект `calculation`, что и при первичном расчете.
Система автоматически запустит **Smart Allocation**:
*   Если увеличили стартовый капитал -> он распределится по целям.
*   Если увеличили потребность в Страховке -> она заберет капитал у Инвестиций.

## 4. Редактирование целей и Параметров

Для изменения параметров финансового плана используйте:
`POST /api/client/:id/recalculate`

**Payload:**
```json
{
  "client": {
    "avg_monthly_income": 200000,
    "total_liquid_capital": 1000000
  },
  "goals": [
    {
      "goal_type_id": 1,
      "name": "Госпенсия",
      "target_amount": 150000,
      "ops_capital": 500000,
      "initial_capital": 300000,
      "risk_profile": "BALANCED"
    }
  ]
}
```

**Детальная конфигурация доступных полей:**
См. [`FRONTEND_GOAL_CONFIG.md`](FRONTEND_GOAL_CONFIG.md) — там указаны все редактируемые поля для каждого типа цели (Пенсия, НСЖ, Другие и т.д.).

---

## UI Рекомендации по UI
1.  **Редактирование цели**: Сделайте модалку с формой. При сабмите дергайте `/recalculate`, получайте новый JSON и обновляйте графики на лету без перезагрузки страницы.
2.  **График взносов**: `cash_flow_allocation` может содержать годовые взносы (payment_frequency: 'annual'). Для корректного Bar Chart лучше приводить все к месяцу (делить на 12) или показывать подпись "42 000 ₽ / год".

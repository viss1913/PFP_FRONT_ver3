# Обновление API: Портфель, Активы и Пересчет Целей

Мы добавили на бэкенд логику для построения дашбордов и динамического пересчета плана.

## 1. Получение данных клиента (Дашборды)
**Endpoint**: `GET /api/client/:id`

Теперь в объекте клиента приходит поле `goals_summary` (результат последнего расчета), которое содержит объект `consolidated_portfolio`. Используйте его для построения графиков.

```json
{
  "goals_summary": {
    "summary": {
      "consolidated_portfolio": {
        // ДЛЯ PIE CHART: СТРУКТУРА АКТИВОВ
        "assets_allocation": [
          { "name": "Депозит", "amount": 1000000, "share": 50, "yield": 15 },
          { "name": "Инвестиции", "amount": 1000000, "share": 50, "yield": 20 }
        ],
        // ДЛЯ BAR/PIE CHART: ЕЖЕМЕСЯЧНЫЕ ВЗНОСЫ
        "cash_flow_allocation": [
          { "name": "Инвестиции (Smart)", "amount": 50000, "payment_frequency": "monthly" },
          { "name": "Страхование Жизни", "amount": 42000, "payment_frequency": "annual" } // Обратите внимание на частоту!
        ],
        "total_initial_capital": 2000000,
        "total_monthly_replenishment": 53500 // Приведенное к месяцу (50к + 42к/12)
      },
      // ДЛЯ ГРАФИКА ПДС (Уже было, но напоминаю)
      "pds_cofinancing": { ... }
    },
    "goals": [ ... ] // Детали по каждой цели
  },
  "assets": [ ... ] // Текущие активы клиента (Для отдельного графика "Текущий капитал")
}
```

## 2. Пересчет плана ("Что если?")
**Endpoint**: `POST /api/client/:id/recalculate`

Используйте этот метод, когда клиент хочет поменять параметры цели (срок, сумму) или свои активы/доход прямо внутри плана.

**Request Body (все поля опциональны, отправляйте только то, что изменилось):**
```json
{
  // 1. Изменение параметров целей
  "goals": [
    {
      "goal_type_id": 1,
      "name": "Пенсия",
      "target_amount": 50000000, // Увеличили цель
      "risk_profile": "AGGRESSIVE" // Поменяли риск
      // ...остальные поля цели
    }
    // Отправляйте ВЕСЬ массив целей, даже тех, что не менялись, иначе могут удалиться/сброситься
  ],

  // 2. Изменение данных клиента (Активы, Доход)
  "client": {
    "avg_monthly_income": 300000,
    "total_liquid_capital": 5000000, // Клиент нашел еще денег
    "assets": [ ... ] // Можно обновить список активов
  }
}
```

**Response:**
Возвращает тот же объект `calculation`, что и при первичном расчете.

### 2.1. Особенности пересчета:
1.  **Логика "Заморозки"**: При вызове `/recalculate` (или добавлении/удалении целей) система **не перераспределяет** деньги между целями автоматически. Каждая цель сохраняет свой ранее выделенный капитал.
2.  **Smart Allocation**: Работает **только** на онбординге (метод `firstRun`). При редактировании он отключен, чтобы данные «не прыгали».

### 2.2. Упрощенный формат (NEW!):
Теперь для изменения одной цели не обязательно слать весь массив `goals`. Можно отправить данные цели прямо в корне:
```json
{
  "goal_id": 361,       // ID цели (обязательно)
  "target_amount": 1500000, 
  "risk_profile": "AGGRESSIVE" 
  // ... любые другие поля цели
}
```
*Система сама найдет цель в базе, обновит её и вернет обновленный расчет всего плана.*

## 4. Редактирование целей и Параметров

Для изменения параметров финансового плана используйте:
`POST /api/client/:id/recalculate`

**Payload:**
```json
{
  "client": {
    "avg_monthly_income": 200000,
    "total_liquid_capital": 1000000
  },
  "goals": [
    {
      "goal_type_id": 1,
      "name": "Госпенсия",
      "target_amount": 150000,
      "ops_capital": 500000,
      "initial_capital": 300000,
      "risk_profile": "BALANCED"
    }
  ]
}
```

**Детальная конфигурация доступных полей:**
См. [`FRONTEND_GOAL_CONFIG.md`](FRONTEND_GOAL_CONFIG.md) — там указаны все редактируемые поля для каждого типа цели (Пенсия, НСЖ, Другие и т.д.).

---

## 5. Добавление и Удаление целей

Если клиент решил добавить новую цель или отказаться от существующей:

### Добавление цели
**Endpoint**: `POST /api/client/:id/goals`
**Body**: Параметры новой цели (см. `GOAL_EDIT_LOGIC.md`)

```json
{
  "goal_type_id": 4,
  "name": "Новая машина",
  "target_amount": 3000000,
  "term_months": 36,
  "risk_profile": "BALANCED"
}
```
*Результат: Цель сохранится в базу, и вы получите обновленный расчет всего плана.*

### Удаление цели
**Endpoint**: `DELETE /api/client/:id/goals/:goalId`

*Результат: Цель удалится из базы, "Бассейн" перераспределится, вы получите обновленный расчет.*

---

## UI Рекомендации по UI
1.  **Редактирование цели**: Сделайте модалку с формой. При сабмите дергайте `/recalculate`, получайте новый JSON и обновляйте графики на лету без перезагрузки страницы.
2.  **График взносов**: `cash_flow_allocation` может содержать годовые взносы (payment_frequency: 'annual'). Для корректного Bar Chart лучше приводить все к месяцу (делить на 12) или показывать подпись "42 000 ₽ / год".

---

## 6. Упрощение JSON (Обновление 11.02.2026)

Для облегчения ответов и удобства отладки мы внесли следующие изменения:

1.  **Чистый JSON**: По умолчанию во всех ответах API скрыто поле `details.yearly_breakdown` (годовая разбивка). JSON стал значительно компактнее. Полные данные по-прежнему сохраняются в БД и доступны для генерации PDF-отчетов.
2.  **Порядок полей**: В объектах целей ключевые поля (`goal_name`, `goal_type`, `goal_type_id`, `goal_id`) теперь всегда стоят **в самом начале**.
3.  **`client_id` в `firstRun`**: Метод `POST /api/client/firstRun` теперь возвращает `client_id` в корне объекта.

**Методы с упрощенным JSON:** `GET /api/client/:id`, `POST /api/client/firstRun`, `POST /api/client/:id/recalculate`.

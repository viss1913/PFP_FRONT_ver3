# Интеграция PFP API (Multi-tenancy)

Для корректной работы расчета ПФП и отображения партнерских данных (портфели, продукты) в запросы необходимо внести следующие изменения.

## 1. Обязательный заголовок (Header)

Во все запросы, связанные с расчетом ПФП и получением настроек, необходимо добавить заголовок идентификации проекта.

- **Заголовок:** `X-Project-Key`
- **Значение для стандартного проекта:** `pk_proj_0e9fdde1e8cd961121906f04507af06e4afec281a58012c4`

**Пример (Axios):**
```javascript
api.defaults.headers.common['X-Project-Key'] = 'pk_proj_0e9fdde1e8cd961121906f04507af06e4afec281a58012c4';
```

## 2. Пострадавшие эндпоинты

Наиболее критичные методы, требующие этот заголовок:
- `POST /api/v1/client/calculate-first-run`
- `POST /api/v1/client/first-run`
- `POST /api/v1/client/:id/recalculate`
- `GET /api/v1/portfolios`
- `GET /api/v1/products`

## 3. Автоматический Fallback

Если заголовок `X-Project-Key` отсутствует:
1. Система попробует определить проект по `project_id` авторизованного пользователя (Агента).
2. Если пользователь не привязан к проекту, запрос может вернуть ошибку или пустые данные (так как глобальных портфелей больше нет, они все в Проекте 1).

## 4. Изменения в теле запроса (Client Object)

Рекомендуется передавать `project_id` внутри объекта клиента для обеспечения консистентности данных.

```json
{
  "client": {
    "fio": "Иван Иванов",
    "project_id": 1,
    "...": "..."
  },
  "goals": [],
  "assets": []
}
```

## 5. Обработка ошибок

- **401/403**: Ошибки авторизации (стандартно).
- **404 Project not found**: Передан неверный или неактивный `X-Project-Key`.
- **500 (Calculation Trace)**: Если расчет падает, в теле ответа или логах будет детальная информация о том, какой именно проектный конфиг не был найден.
